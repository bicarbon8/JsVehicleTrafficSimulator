/*! jsvts v2.0.0, created by: Jason Holt Smith <bicarbon8@gmail.com> 2015-02-06 17:24:00 */
"strict mode";var JSVTS={ID_COUNT:0,CRASH_CLEANUP_MAX_DELAY:3e5,CRASH_CLEANUP_MIN_DELAY:6e4,startTime:0,elapsed:0,realtime:!1,keepMoving:!1,totalElapsedTime:0,roadways:[],defaultRoadway:0,timeStep:10,init:function(){JSVTS.initPageElements(),JSVTS.initObjects(),JSVTS.onLoadComplete()},reset:function(){JSVTS.Plotter.reset(),JSVTS.Map.reset(),JSVTS.totalElapsedTime=0,JSVTS.init()},resize:function(){var a=JSVTS.getWidthHeight();JSVTS.Plotter.resize(a.width,a.height)},initPageElements:function(){var a=JSVTS.getWidthHeight();JSVTS.docWidth=a.width,JSVTS.docHeight=a.height},initObjects:function(){JSVTS.Plotter.init(JSVTS.docWidth,JSVTS.docHeight),JSVTS.Plotter.render(),JSVTS.loadRoadway(JSVTS.defaultRoadway)},getWidthHeight:function(){var a=window,b=document,c=b.documentElement,d=b.querySelector("body"),e=a.innerWidth||c.clientWidth||d.clientWidth,f=a.innerHeight||c.clientHeight||d.clientHeight;return{width:e,height:f}},toggleAnimationState:function(){JSVTS.keepMoving?JSVTS.stop():JSVTS.start()},start:function(){JSVTS.keepMoving=!0,JSVTS.move()},stop:function(){JSVTS.keepMoving=!1},move:function(){JSVTS.elapsed=JSVTS.timeStep,JSVTS.Map.getMovables().forEach(function(a){a.update(JSVTS.elapsed)}),JSVTS.Plotter.render(),JSVTS.totalElapsedTime+=JSVTS.elapsed,JSVTS.keepMoving&&requestAnimationFrame(JSVTS.move)},loadRoadway:function(a){var b=JSVTS.roadways[a];JSVTS.TxtToMapParser.parseMapJson(b.map),JSVTS.Plotter.render()},onLoadComplete:function(){}},JSVTS=JSVTS||{};JSVTS.Utils={getRandomBetween:function(a,b){return Math.random()*(b-a)+a},getDistanceBetweenTwoPoints:function(a,b){return new THREE.Line3((new THREE.Vector3).copy(a),(new THREE.Vector3).copy(b)).distance()},angleFormedBy:function(a,b){var c=(new THREE.Vector3).copy(a.end).sub(a.start).normalize(),d=(new THREE.Vector3).copy(b.end).sub(b.start).normalize();return Math.acos(c.dot(d))*(180/Math.PI)},isCollidingWith:function(a,b){return a.isIntersectionBox(b)?!0:!1},convertKmphToMps:function(a){var b=0,c=3600,d=1e3;return b=a/c*d},convertMpsToKmph:function(a){var b=0,c=3600,d=1e3;return b=a*c/d}};var JSVTS=JSVTS||{};JSVTS.Map={_movables:[],up:new THREE.Vector3(0,1,0),reset:function(){JSVTS.Map._movables=[]},addMovable:function(a){a instanceof JSVTS.Movable&&(JSVTS.Map._movables[a.id]=a,JSVTS.Plotter&&JSVTS.Plotter.addRenderable(a))},removeMovable:function(a){a instanceof JSVTS.Movable&&(delete JSVTS.Map._movables[a.id],JSVTS.Plotter&&JSVTS.Plotter.removeRenderable(a),a=null)},getMovables:function(){return JSVTS.Map._movables.filter(function(a){return a})},getMovableById:function(a){return JSVTS.Map._movables[a]},getMovableByType:function(a){return JSVTS.Map._movables.filter(function(b){return b instanceof a})},updateMovables:function(a){for(var b in a){var c=a[b];JSVTS.Map._movables[c.id]=c}},getTypesInRangeOf:function(a,b,c){return JSVTS.Map._movables.filter(function(d){return d instanceof a&&JSVTS.Utils.getDistanceBetweenTwoPoints(b,d.config.location)<=c})},getTypesInRangeOfOnSegment:function(a,b,c,d){return JSVTS.Map._movables.filter(function(e){return e instanceof a&&e.segment&&e.segment.id===d&&JSVTS.Utils.getDistanceBetweenTwoPoints(b,e.config.location)<=c})},getSegments:function(){return JSVTS.Map.getMovableByType(JSVTS.Segment)},getSegmentsStartingAt:function(a){return JSVTS.Map.getSegments().filter(function(b){return b.config.start.x===a.x&&b.config.start.y===a.y&&b.config.start.z===a.z})},getAvailableSegmentsContainingPoint:function(a){var b=[],c=JSVTS.Map.getSegments();for(var d in c){var e=c[d];if(e.config.start.x===a.x&&e.config.start.y===a.y&&e.config.start.z===a.z||e.config.end.x===a.x&&e.config.end.y===a.y&&e.config.end.z===a.z)b.push(e);else for(var f in e.laneChangePoints){var g=e.laneChangePoints[f];g.x===a.x&&g.y===a.y&&g.z===a.z&&b.push(e)}}return b},getSimilarSegmentsInRoad:function(a){var b=[],c=JSVTS.Map.getSegments().filter(function(b){return b.config.name===a.config.name&&b.id!==a.id});for(var d in c){var e=c[d],f=new THREE.Line3(e.config.start,e.config.end),g=new THREE.Line3(a.config.start,a.config.end);e.config.name===a.config.name&&Math.abs(JSVTS.Utils.angleFormedBy(f,g))<5&&b.push(e)}return b},getTypesInSegment:function(a,b){return JSVTS.Map._movables.filter(function(c){return c.segment&&c.segment.id===a&&c instanceof b})},getTypesNotInSegment:function(a,b){return JSVTS.Map._movables.filter(function(c){return c.segment&&c.segment.id!==a&&c instanceof b})},getVehicles:function(){return JSVTS.Map.getMovableByType(JSVTS.Vehicle)},getVehiclesInSegment:function(a){return JSVTS.Map.getTypesInSegment(a,JSVTS.Vehicle)},getVehiclesNotInSegment:function(a){return JSVTS.Map.getTypesNotInSegment(a,JSVTS.Vehicle)},getTfcsInSegment:function(a){return JSVTS.Map.getTypesInSegment(a,JSVTS.TrafficFlowControl)}};var JSVTS=JSVTS||{};JSVTS.Plotter={renderer:null,scene:null,camera:null,controls:null,stats:null,light:null,width:0,height:0,init:function(a,b){JSVTS.Plotter.width=a,JSVTS.Plotter.height=b,JSVTS.Plotter.initRenderer(a,b),JSVTS.Plotter.initCamera(a,b),JSVTS.Plotter.initControls(),JSVTS.Plotter.initLight(),JSVTS.Plotter.initStats(),JSVTS.Plotter.initScene([JSVTS.Plotter.camera,JSVTS.Plotter.light]),JSVTS.Plotter.initDom([JSVTS.Plotter.renderer.domElement,JSVTS.Plotter.stats.domElement]),JSVTS.Plotter.render()},initRenderer:function(a,b){JSVTS.Plotter.renderer=new THREE.WebGLRenderer,JSVTS.Plotter.resize(a,b)},initLight:function(){var a=new THREE.PointLight(16777215);a.position.x=10,a.position.y=50,a.position.z=130,JSVTS.Plotter.light=a},initCamera:function(a,b){var c=45,d=a/b,e=.1,f=1e4;JSVTS.Plotter.camera=new THREE.PerspectiveCamera(c,d,e,f),JSVTS.Plotter.camera.position.z=228,JSVTS.Plotter.camera.position.y=250,JSVTS.Plotter.camera.position.x=115,JSVTS.Plotter.camera.lookAt(new THREE.Vector3(75,0,115))},initStats:function(){JSVTS.Plotter.stats=new JSVTS.Stats,JSVTS.Plotter.stats.domElement.style.position="absolute",JSVTS.Plotter.stats.domElement.style.top="0px",JSVTS.Plotter.stats.domElement.style.right="0px"},initControls:function(){JSVTS.Plotter.controls=new THREE.OrbitControls(JSVTS.Plotter.camera),JSVTS.Plotter.controls.damping=.2,JSVTS.Plotter.controls.addEventListener("change",function(){JSVTS.Plotter.render()})},initScene:function(a){JSVTS.Plotter.scene=new THREE.Scene,JSVTS.Plotter.scene.add(new THREE.AxisHelper(1e4));for(var b in a){var c=a[b];JSVTS.Plotter.scene.add(c)}},initDom:function(a){for(var b in a){var c=a[b];document.querySelector("body").appendChild(c)}},render:function(){JSVTS.Plotter.renderer.render(JSVTS.Plotter.scene,JSVTS.Plotter.camera),JSVTS.Plotter.stats.update()},reset:function(){JSVTS.Plotter.renderer&&document.querySelector("body").removeChild(JSVTS.Plotter.renderer.domElement),JSVTS.Plotter.stats&&document.querySelector("body").removeChild(JSVTS.Plotter.stats.domElement),JSVTS.Plotter.renderer=null,JSVTS.Plotter.scene=null,JSVTS.Plotter.camera=null,JSVTS.Plotter.controls=null,JSVTS.Plotter.stats=null},resize:function(a,b){JSVTS.Plotter.renderer.setSize(a,b),JSVTS.Plotter.camera&&(JSVTS.Plotter.camera.aspect=a/b,JSVTS.Plotter.camera.updateProjectionMatrix(),JSVTS.Plotter.render())},addRenderable:function(a){a instanceof JSVTS.Renderable&&JSVTS.Plotter.scene.add(a.mesh)},removeRenderable:function(a){a instanceof JSVTS.Renderable&&(JSVTS.Plotter.scene.remove(a.mesh),a.dispose())}};var JSVTS=JSVTS||{};JSVTS.TxtToMapParser={parseMapJson:function(a){a&&JSVTS.TxtToMapParser.parseSegmentsJson(a.segments)},parseSegmentsJson:function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c],e=new THREE.Vector3(d.start.x,d.start.y,d.start.z),f=new THREE.Vector3(d.end.x,d.end.y,d.end.z),g=new JSVTS.Segment({start:e,end:f,speedLimit:void 0===d.speedlimit?60:d.speedlimit,name:d.roadname,isInlet:d.isinlet||!1,isMergeLane:d.ismergelane||!1});JSVTS.Map.addMovable(g),JSVTS.TxtToMapParser.parseTfcJson(d.tfc,g),JSVTS.TxtToMapParser.parseGeneratorJson(d.generator,g)}return b},parseTfcJson:function(a,b){var c=null;if(a){var d=a.type;switch(d){case"stoplight":var e=void 0===a.greenduration?56:a.greenduration,f=void 0===a.redduration?60:a.redduration,g=void 0===a.startstate?0:a.startstate,h=void 0===a.yellowduration?4:a.yellowduration;c=new JSVTS.StopLight({greenDuration:e,yellowDuration:h,redDuration:f,startState:g});break;default:throw"unknown TrafficFlowControl type of '"+d+"' specified."}b.attachMovable(c,b.config.end,b.config.start),JSVTS.Map.addMovable(c)}},parseGeneratorJson:function(a,b){var c=null;a&&(c=new JSVTS.VehicleGenerator({delay:void 0===a.delay?1:a.delay}),b.attachMovable(c,b.config.start,b.config.end),JSVTS.Map.addMovable(c))}};var JSVTS=JSVTS||{};JSVTS.MOVABLE_OPTIONS=function(){var a={name:"",location:new THREE.Vector3(0,0,0),generateId:!0};return a},JSVTS.Movable=function(a){this.id=null,this.config=JSVTS.MOVABLE_OPTIONS();for(var b in a)this.config[b]=a[b];this.config.generateId&&(this.id=JSVTS.ID_COUNT++)},JSVTS.Movable.prototype.update=function(){throw"abstract base method must be overridden to be called."},JSVTS.Movable.prototype.moveTo=function(a){a&&this.config.location.copy(a)};var JSVTS=JSVTS||{};JSVTS.Renderable=function(a){JSVTS.Movable.call(this,a),this.mesh=null,this.material=null,this.texture=null,this.generateMesh(a)},JSVTS.Renderable.prototype=Object.create(JSVTS.Movable.prototype),JSVTS.Renderable.prototype.constructor=JSVTS.Renderable,JSVTS.Renderable.prototype.updated=function(){this.mesh.updateMatrix()},JSVTS.Renderable.prototype.generateMesh=function(){throw"abstract method cannot be called directly"},JSVTS.Renderable.prototype.moveTo=function(a,b){JSVTS.Movable.prototype.moveTo.call(this,a),a&&this.mesh.position.set(a.x,a.y,a.z),b&&this.mesh.lookAt(b),this.updated()},JSVTS.Renderable.prototype.moveBy=function(a){a>0&&(this.mesh.translateZ(a),this.moveTo(this.mesh.position))},JSVTS.Renderable.prototype.dispose=function(){this.mesh&&this.mesh.geometry&&this.mesh.geometry.dispose(),this.material&&this.material.dispose(),this.texture&&this.texture.dispose()};var JSVTS=JSVTS||{};JSVTS.SEG_OPTIONS=function(){var a={start:THREE.Vector3(-10,0,0),end:THREE.Vector3(10,0,0),width:3,isInlet:!1,name:"",speedLimit:30,isMergeLane:!1};return a},JSVTS.Segment=function(a){var b=JSVTS.SEG_OPTIONS();for(var c in a)b[c]=a[c];JSVTS.Renderable.call(this,b),this.tangent=null,this.axis=null,this.radians=null,this.laneChangePoints=[],this.generateLaneChangePoints()},JSVTS.Segment.prototype=Object.create(JSVTS.Renderable.prototype),JSVTS.Segment.prototype.constructor=JSVTS.Segment,JSVTS.Segment.prototype.copy=function(a){this.id=a.id,this.config.start=(new THREE.Vector3).copy(a.config.start),this.config.end=(new THREE.Vector3).copy(a.config.end),this.generateMesh(),this.generateLaneChangePoints()},JSVTS.Segment.prototype.attachMovable=function(a,b,c){a instanceof JSVTS.Movable&&(a.segment=this,a instanceof JSVTS.Renderable?a.moveTo(b,c):a.moveTo(b))},JSVTS.Segment.prototype.generateMesh=function(a){this.spline=new THREE.SplineCurve3([a.start,a.end]);var b=new THREE.LineBasicMaterial({color:16777215}),c=new THREE.Geometry;c.vertices=this.spline.getPoints(1);var d=new THREE.Line(c,b);this.mesh=d,this.tangent||(this.tangent=this.spline.getTangent(0).normalize(),this.axis=new THREE.Vector3,this.axis.crossVectors(JSVTS.Map.up,this.tangent).normalize(),this.radians=Math.acos(JSVTS.Map.up.dot(this.tangent)));var e=this.id;this.config.name&&""!==this.config.name&&(e=this.config.name);var f=new THREE.TextGeometry(e,{size:2,height:.05}),g=new THREE.Mesh(f,b),h=this.spline.getPoint(.5);g.position.set(h.x,h.y,h.z),g.lookAt(this.config.end),g.rotateY(90*(Math.PI/180)),g.translateY(this.mesh.position.y+5),this.mesh.add(g)},JSVTS.Segment.prototype.generateLaneChangePoints=function(){for(var a=new THREE.SphereGeometry(1),b=new THREE.MeshBasicMaterial,c=new THREE.Mesh(a,b),d=1,e=d;e<this.getLength();e+=d)c.position.set(this.config.start.x,this.config.start.y,this.config.start.z),c.lookAt(this.config.end),c.translateZ(e),this.laneChangePoints.push((new THREE.Vector3).copy(c.position));c.geometry.dispose()},JSVTS.Segment.prototype.getLength=function(){return this.spline.getLength(0)},JSVTS.Segment.prototype.update=function(){};var JSVTS=JSVTS||{};JSVTS.VEH_OPTIONS=function(){var a={width:2,length:4,height:2,reactionTime:2.5,acceleration:3.5,deceleration:7,changeLaneDelay:5};return a},JSVTS.Vehicle=function(a){var b=JSVTS.VEH_OPTIONS();for(var c in a)b[c]=a[c];JSVTS.Renderable.call(this,b),this.isChangingLanes=!1,this.changeLaneTime=null,this.velocity=0,this.crashed=!1,this.crashCleanupTime=null},JSVTS.Vehicle.prototype=Object.create(JSVTS.Renderable.prototype),JSVTS.Vehicle.prototype.constructor=JSVTS.Vehicle,JSVTS.Vehicle.prototype.getLookAheadDistance=function(){var a=JSVTS.Utils.convertKmphToMps(this.velocity),b=-Math.pow(a,2)/(2*-this.config.deceleration)/2,c=this.config.reactionTime*a,d=b+2*this.config.length+c;return d},JSVTS.Vehicle.prototype.generateMesh=function(a){if(!this.mesh){var b=new THREE.BoxGeometry(a.width,a.height,a.length),c=new THREE.MeshBasicMaterial({color:16777215,wireframe:!0}),d=new THREE.Mesh(b,c);this.mesh=d}},JSVTS.Vehicle.prototype.update=function(a){var b=!1,c=a/1e3,d=!1;this.shouldStop()&&(b=!0),this.updateVelocity(a,b);var e=this.velocity*c;if(e>0){var f=JSVTS.Utils.getDistanceBetweenTwoPoints(this.config.location,this.segment.config.end);if(e>=f){var g=null;if(this.isChangingLanes?(this.isChangingLanes=!1,g=JSVTS.Map.getAvailableSegmentsContainingPoint(this.segment.config.end)):g=JSVTS.Map.getSegmentsStartingAt(this.segment.config.end),g&&g.length>0){var h=Math.floor(Math.random()*g.length),i=g[h];i.attachMovable(this,this.segment.config.end,i.config.end),e-=f}else JSVTS.Map.removeMovable(this),d=!0}}if(!d)if(this.crashed)if(this.brake(a),this.crashCleanupTime)this.crashCleanupTime<=JSVTS.totalElapsedTime&&(console.log("Vehicle removed: "+this.id),JSVTS.Map.removeMovable(this));else{console.log("Vehicle crashed: "+this.id);var j=Math.random();.8>=j&&(this.crashCleanupTime=Math.random()*JSVTS.CRASH_CLEANUP_MIN_DELAY),this.crashCleanupTime=Math.random()*(JSVTS.CRASH_CLEANUP_MAX_DELAY-JSVTS.CRASH_CLEANUP_MIN_DELAY)+JSVTS.CRASH_CLEANUP_MIN_DELAY}else this.moveBy(e)},JSVTS.Vehicle.prototype.updateVelocity=function(a,b){this.segment&&(this.velocity<this.segment.config.speedLimit&&!b&&this.accelerate(a),(this.velocity>this.segment.config.speedLimit||b)&&this.brake(a))},JSVTS.Vehicle.prototype.accelerate=function(a){var b=a/1e3;this.velocity+=JSVTS.Utils.convertMpsToKmph(this.config.acceleration*b),this.velocity>this.segment.config.speedLimit&&(this.velocity=this.segment.config.speedLimit),this.mesh.material.color.setHex(6750054)},JSVTS.Vehicle.prototype.brake=function(a){var b=a/1e3;this.velocity-=JSVTS.Utils.convertMpsToKmph(this.config.deceleration*b),this.velocity<0&&(this.velocity=0),this.mesh.material.color.setHex(16711680)},JSVTS.Vehicle.prototype.getBoundingBox=function(){return this.mesh.geometry.computeBoundingBox(),this.mesh.geometry.boundingBox},JSVTS.Vehicle.prototype.shouldStop=function(a,b,c){a||(a=this.segment);var d=b||this.getLookAheadDistance(),e=this.shouldStopForVehicle(d);if(e&&e.stop){if(c)return e;var f=(new THREE.Box3).setFromObject(this.mesh),g=JSVTS.Map.getMovableById(e.id),h=(new THREE.Box3).setFromObject(g.mesh);if(JSVTS.Utils.isCollidingWith(f,h))this.crashed=!0,g.crashed=!0;else{var i=this.changeLanesIfAvailable(a);if(!i)return e}}var j=this.shouldStopForTfc(d);if(j&&j.stop)return j;var k=this.shouldSlowForCorner(d);return k&&k.stop?k:void 0},JSVTS.Vehicle.prototype.shouldStopForVehicle=function(a){if(a>0){var b=JSVTS.Map.getTypesInRangeOf(JSVTS.Vehicle,this.config.location,a);for(var c in b){var d=b[c];if(d.id!==this.id&&this.hasInView(d)){if(d.segment&&d.segment.id===this.segment.id)return{stop:!0,type:"vehicle",id:d.id};var e=this.segment.id,f=JSVTS.Map.getAvailableSegmentsContainingPoint(this.segment.config.end).filter(function(a){return a.id!==e}),g=f.filter(function(a){return a.id===d.segment.id});if(d.segment&&g.length>0)return{stop:!0,type:"vehicle",id:d.id};var h=JSVTS.Utils.getDistanceBetweenTwoPoints(this.config.location,this.segment.config.end);if(a>h){var i=!1;for(var j in f){var k=f[j],l=(new JSVTS.TempVehicle).copyFrom(this);if(k.attachMovable(l,k.config.start,k.config.end),i=l.shouldStopForVehicle(a-h),i&&i.stop)return i}}}}}return!1},JSVTS.Vehicle.prototype.shouldStopForTfc=function(a){if(a>0){var b=JSVTS.Map.getTypesInRangeOfOnSegment(JSVTS.TrafficFlowControl,this.config.location,a,this.segment.id);for(var c in b){var d=b[c];if(d.shouldStop(this))return{stop:!0,type:"tfc",segmentId:d.segment.id,id:d.id}}}return!1},JSVTS.Vehicle.prototype.changeLanesIfAvailable=function(a){if(!this.changeLaneTime||this.changeLaneTime<JSVTS.totalElapsedTime){var b=null;if(a){var c=JSVTS.Map.getSimilarSegmentsInRoad(a);for(var d in c){var e=c[d];for(var f in e.laneChangePoints){var g=e.laneChangePoints[f],h=new THREE.Line3(this.config.location,g),i=new THREE.Line3(a.config.start,a.config.end),j=Math.abs(JSVTS.Utils.angleFormedBy(h,i));25>=j&&j>5&&(b?h.distance()<JSVTS.Utils.getDistanceBetweenTwoPoints(b,this.config.location)&&(b=g):b=g)}}}if(b){var k=new JSVTS.Segment({start:this.config.location,end:b,speedLimit:this.segment.config.speedLimit,generateId:!1});k.dispose();var l=(new JSVTS.TempVehicle).copyFrom(this);l.isChangingLanes=!0,k.attachMovable(l,k.config.start,k.config.end);var m=2*this.getLookAheadDistance();if(!l.shouldStop(k,m,!0))return k.attachMovable(this,k.config.start,k.config.end),this.changeLaneTime=JSVTS.totalElapsedTime+1e3*this.config.changeLaneDelay,this.isChangingLanes=!0,!0}}return!1},JSVTS.Vehicle.prototype.shouldSlowForCorner=function(a){var b=JSVTS.Utils.getDistanceBetweenTwoPoints(this.config.location,this.segment.config.end);if(a>b){var c=0,d=new THREE.Line3(this.segment.config.start,this.segment.config.end),e=JSVTS.Map.getSegmentsStartingAt(this.segment.config.end);for(var f in e){var g=e[f],h=new THREE.Line3(g.config.start,g.config.end),i=Math.abs(JSVTS.Utils.angleFormedBy(d,h));i>c&&(c=i)}var j=this.corneringSpeedCalculator(c,this.velocity);if(this.velocity>j)return{stop:!0,type:"cornering",heading:c}}return!1},JSVTS.Vehicle.prototype.corneringSpeedCalculator=function(a){return 12>a?this.velocity:25>a?100:45>a?30:90>a?10:135>a?5:a>=135?1:void 0},JSVTS.Vehicle.prototype.hasInView=function(a){if(a instanceof JSVTS.Renderable){var b=45;this.isChangingLanes&&(b=90);var c=a.mesh.geometry.vertices.map(function(b){return(new THREE.Vector3).copy(b).applyMatrix4(a.mesh.matrix)});for(var d in c){var e=c[d],f=new THREE.Line3(this.config.location,this.segment.config.end),g=new THREE.Line3(this.config.location,e);if(Math.abs(JSVTS.Utils.angleFormedBy(f,g))<=b)return!0}}return!1};var JSVTS=JSVTS||{};JSVTS.TVEH_OPTIONS=function(){var a={generateId:!1};return a},JSVTS.TempVehicle=function(a){var b=JSVTS.TVEH_OPTIONS();for(var c in a)b[c]=a[c];JSVTS.Vehicle.call(this,b),this.dispose()},JSVTS.TempVehicle.prototype=Object.create(JSVTS.Vehicle.prototype),JSVTS.TempVehicle.prototype.constructor=JSVTS.TempVehicle,JSVTS.TempVehicle.prototype.copyFrom=function(a){if(a){for(var b in a)"function"!=typeof a[b]&&"object"!=typeof a[b]&&(this[b]=a[b]);for(var b in a.config)"function"!=typeof a.config[b]&&"object"!=typeof a.config[b]&&(this.config[b]=a.config[b]);this.id=a.id,this.config.location=(new THREE.Vector3).copy(a.config.location)}return this};var JSVTS=JSVTS||{};JSVTS.TFC_ID_COUNT=0,JSVTS.TrafficFlowControl=function(a){JSVTS.Renderable.call(this,a)},JSVTS.TrafficFlowControl.prototype=Object.create(JSVTS.Renderable.prototype),JSVTS.TrafficFlowControl.prototype.constructor=JSVTS.TrafficFlowControl,JSVTS.TrafficFlowControl.prototype.shouldStop=function(){throw"abstract base method must be overridden to be called."};var JSVTS=JSVTS||{};JSVTS.StopLightState={GREEN:0,YELLOW:1,RED:2},JSVTS.STOPLIGHT_OPTIONS=function(){var a={greenDuration:56,yellowDuration:4,redDuration:60,startState:JSVTS.StopLightState.GREEN,radius:1};return a},JSVTS.StopLight=function(a){var b=JSVTS.STOPLIGHT_OPTIONS();for(var c in a)b[c]=a[c];JSVTS.TrafficFlowControl.call(this,b),this.startState=this.config.startState,this.currentState=this.startState,this.stateElapsed=null},JSVTS.StopLight.prototype=Object.create(JSVTS.TrafficFlowControl.prototype),JSVTS.StopLight.prototype.constructor=JSVTS.StopLight,JSVTS.StopLight.prototype.generateMesh=function(a){if(!this.mesh){var b=new THREE.SphereGeometry(a.radius),c=new THREE.MeshBasicMaterial({color:16777215});mesh=new THREE.Mesh(b,c),this.mesh=mesh}this.update(0)},JSVTS.StopLight.prototype.update=function(a){for(var b=0;a>b;b++)switch(this.stateElapsed++,this.currentState){case JSVTS.StopLightState.GREEN:this.stateElapsed>=1e3*this.config.greenDuration&&(this.currentState=JSVTS.StopLightState.YELLOW,this.stateElapsed=0);break;case JSVTS.StopLightState.YELLOW:this.stateElapsed>=1e3*this.config.yellowDuration&&(this.currentState=JSVTS.StopLightState.RED,this.stateElapsed=0);break;case JSVTS.StopLightState.RED:this.stateElapsed>=1e3*this.config.redDuration&&(this.currentState=JSVTS.StopLightState.GREEN,this.stateElapsed=0)}switch(this.currentState){case JSVTS.StopLightState.GREEN:this.mesh.material.color.setHex(65280);break;case JSVTS.StopLightState.YELLOW:this.mesh.material.color.setHex(16776960);break;case JSVTS.StopLightState.RED:this.mesh.material.color.setHex(16711680)}},JSVTS.StopLight.prototype.shouldStop=function(a){var b=JSVTS.Utils.getDistanceBetweenTwoPoints(a.config.location,this.config.location);return b<a.getLookAheadDistance()-2*a.config.length?this.currentState===JSVTS.StopLightState.RED?!0:!1:this.currentState===JSVTS.StopLightState.YELLOW||this.currentState===JSVTS.StopLightState.RED?!0:!1};var JSVTS=JSVTS||{};JSVTS.VG_OPTIONS=function(){var a={delay:5};return a},JSVTS.VehicleGenerator=function(a){var b=JSVTS.VG_OPTIONS();for(var c in a)b[c]=a[c];JSVTS.Movable.call(this,b),this.nextVehicle=null,this.elapsedMs=0},JSVTS.VehicleGenerator.prototype=Object.create(JSVTS.Movable.prototype),JSVTS.VehicleGenerator.prototype.constructor=JSVTS.VehicleGenerator,JSVTS.VehicleGenerator.prototype.update=function(a){for(var b=0;a>b;b++)this.elapsedMs++,this.elapsedMs>=this.config.delay&&this.generate()},JSVTS.VehicleGenerator.prototype.generate=function(){this.nextVehicle||(this.nextVehicle=this.prepareNewVehicle()),this.canGenerate(this.nextVehicle)&&(JSVTS.Map.addMovable(this.nextVehicle),this.elapsedMs=0,this.nextVehicle=null)},JSVTS.VehicleGenerator.prototype.canGenerate=function(a){var b=JSVTS.Map.getTypesInRangeOf(JSVTS.Vehicle,a.config.location,3*a.config.length);for(var c in b){var d=b[c],e=(new THREE.Box3).setFromObject(d.mesh),f=(new THREE.Box3).setFromObject(a.mesh);if(JSVTS.Utils.isCollidingWith(e,f))return!1}return!0},JSVTS.VehicleGenerator.prototype.prepareNewVehicle=function(){var a=new JSVTS.Vehicle({acceleration:JSVTS.Utils.getRandomBetween(2.5,4.5),deceleration:JSVTS.Utils.getRandomBetween(3.8,5),reactionTime:JSVTS.Utils.getRandomBetween(2.5,3.5),changeLaneDelay:Math.floor(JSVTS.Utils.getRandomBetween(5,15)),length:JSVTS.Utils.getRandomBetween(3,5)}),b=this.segment;return b.attachMovable(a,b.config.start,b.config.end),a};var JSVTS=JSVTS||{};JSVTS.Stats=function(a){this.domElement=null,this.startTime=(new Date).getTime(),this.elapsedMs=0,this.init(a)},JSVTS.Stats.prototype.init=function(){this.domElement=document.createElement("div"),this.domElement.id="jsvtsStats",this.domElement.style.cssText="padding: 0px 0px 3px 3px; text-align: left; background-color: rgb(0, 0, 34);";var a=document.createElement("div");a.id="jsvtsStatsElapsed",a.style.cssText="color: rgb(0, 255, 255); font-family: Helvetica, Arial, sans-serif; font-size: 9px; font-weight: bold; line-height: 15px;",this.domElement.appendChild(a);var b=document.createElement("div");b.id="jsvtsStatsSimulation",b.style.cssText="color: rgb(0, 255, 255); font-family: Helvetica, Arial, sans-serif; font-size: 9px; font-weight: bold; line-height: 15px;",this.domElement.appendChild(b);var c=document.createElement("div");c.id="jsvtsStatsReal",c.style.cssText="color: rgb(0, 255, 255); font-family: Helvetica, Arial, sans-serif; font-size: 9px; font-weight: bold; line-height: 15px;",this.domElement.appendChild(c)},JSVTS.Stats.prototype.update=function(){var a=JSVTS.totalElapsedTime-this.elapsedMs;this.elapsedMs+=a,this.domElement.querySelector("#jsvtsStatsElapsed").innerHTML="step: "+a,this.domElement.querySelector("#jsvtsStatsSimulation").innerHTML="sim: "+this.convertMsToHumanReadable(JSVTS.totalElapsedTime),this.domElement.querySelector("#jsvtsStatsReal").innerHTML="real: "+this.convertMsToHumanReadable((new Date).getTime()-this.startTime)},JSVTS.Stats.prototype.convertMsToHumanReadable=function(a){var b=a/1e3,c=parseFloat(Math.round(b%60*100)/100).toFixed(2);b/=60;var d=Math.floor(b%60);b/=60;var e=Math.floor(b%24),f=e+":"+d+":"+c;return f};
//# sourceMappingURL=jsvts.min.js.map